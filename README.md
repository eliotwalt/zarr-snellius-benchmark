# Benchmarking zarr on Snellius

Zarr + Xarray + Pytorch = pain

## Setup 

```bash
# Zarr V2
./make_env_zarr-v2.sh
source env/venv_zarr-v2/bin/activate

# Zarr V3
./make_env_zarr-v3.sh
source env/venv_zarr-v3/bin/activate
```

## Download data
- python script: `src/download.py <OPTIONS>` -> many `argparse` option available for experiments. 
- slurm entrypoint: `slurm/download.sh <ZARR_VERSION> <OPTIONS>`, with `ZARR_VERSION` either `2` or `3`.
- examples:
    - `./download_1w_240x121.sh`: Downloads 2000-2022, 2010-2022 and 2020-2022 in zarr v2 and 2020-2022 in zarr v3 to home from `gs://weatherbench2/datasets/era5_weekly/1959-2023_01_10-1h-240x121_equiangular_with_poles_conservative.zarr/` (low resolution).
    - `./download_6h_1440x721.sh`: Downloads 2020-2022 in zarr v2 and v3 to project space from `gs://weatherbench2/datasets/era5/1959-2023_01_10-wb13-6h-1440x721.zarr/`

**WARNING**: Quite basic. No fancy library. No compression optimisation. 

## Benchmark 
- python script: `src/benchmark.py <OPTIONS>` -> many `argparse` option available for experiments. 
- slurm entrypoint: `slurm/benchmark.sh <ZARR_VERSION> <OPTIONS>`, with `ZARR_VERSION` either `2` or `3`.
- examples: 
    - `./benchmark_1w_240x121.sh`: Benchmarks the datasets generated by `./download_1w_240x121.sh` as well as the GCS counterparts for 2020-2022.

This write some logs in `experiments/`. Check out the notebooks `analysis.ipynb` for parsing/plotting examples. 
